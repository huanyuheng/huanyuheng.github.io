---
layout: page
title: åå°å‘å¸ƒ
permalink: /admin/
---

<div class="admin-page">
  <h1 class="admin-title">åšå®¢åå°</h1>
  <p class="admin-desc">
    åœ¨è¿™é‡Œå¯ä»¥ï¼šâ‘  æ–°å»ºæ–‡ç« ï¼›â‘¡ ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©æ–‡ç« å¹¶ç¼–è¾‘ï¼›â‘¢ ä¿®æ”¹å³ä¾§æ ã€Œå·¥ä½œã€å†…å®¹ã€‚
  </p>

  <!-- Token è®¾ç½®å¡ç‰‡ -->
  <div class="admin-card admin-token-card">
    <div class="admin-token-header">
      <div>
        <div class="admin-token-title">GitHub Token</div>
        <div class="admin-token-sub">åªä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼Œç”¨æ¥è°ƒç”¨ GitHub APIã€‚</div>
      </div>
      <button id="post-refresh" class="admin-btn-outline">åˆ·æ–°æ–‡ç« åˆ—è¡¨</button>
    </div>
    <div class="admin-token-body">
      <input id="token-input" type="password"
             placeholder="ç¬¬ä¸€æ¬¡ä½¿ç”¨å…ˆåœ¨è¿™é‡Œç²˜è´´ä½ çš„ä¸ªäººè®¿é—® Tokenï¼ˆclassicï¼Œrepo æƒé™ï¼‰"
             class="admin-input admin-token-input">
      <button id="save-token" class="admin-btn-primary">ä¿å­˜ Tokenï¼ˆä»…æœ¬æœºï¼‰</button>
      <span id="token-status" class="admin-status"></span>
    </div>
  </div>

  <!-- ä¸»ä½“ï¼šå·¦ä¾§æ–‡ç« åˆ—è¡¨ + å³ä¾§ç¼–è¾‘å™¨ -->
  <div class="admin-shell">
    <!-- å·¦ä¾§ï¼šæ–‡ç« åˆ—è¡¨ -->
    <div class="admin-card admin-left">
      <div class="admin-left-header">
        <h2 class="admin-section-title">æ–‡ç« åˆ—è¡¨</h2>
      </div>

      <input id="post-search" class="admin-input admin-search"
             placeholder="æœç´¢æ ‡é¢˜æˆ–æ–‡ä»¶åï¼ˆæ¨¡ç³ŠåŒ¹é…ï¼‰">

      <div id="post-list-status" class="admin-status-small">å°šæœªåŠ è½½æ–‡ç« åˆ—è¡¨ã€‚</div>

      <div id="post-list" class="admin-post-list">
        <!-- åŠ¨æ€å¡«å…… -->
      </div>
    </div>

    <!-- å³ä¾§ï¼šæ–‡ç« ç¼–è¾‘å™¨ -->
    <div class="admin-card admin-right">
      <div class="admin-right-header">
        <h2 id="editor-title" class="admin-section-title">æ–°å»ºæ–‡ç« </h2>
        <button id="post-new" class="admin-btn-outline-small">æ–°å»ºç©ºç™½</button>
      </div>
      <div id="current-file-info" class="admin-current-file"></div>

      <form id="post-form" class="admin-form">
        <div class="admin-form-row">
          <label>æ ‡é¢˜ï¼ˆtitleï¼‰</label>
          <input id="post-title" type="text" required class="admin-input">
        </div>

        <div class="admin-form-row">
          <label>æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰</label>
          <input id="post-date" type="text" class="admin-input admin-input-short">
        </div>

        <div class="admin-form-row">
          <label>æ–‡ä»¶å slugï¼ˆå¯é€‰ï¼Œä¾‹å¦‚ <code>my-first-post</code>ï¼‰</label>
          <input id="post-slug" type="text" class="admin-input">
          <div class="admin-help">
            æœ€ç»ˆæ–‡ä»¶åï¼š<code>YYYY-MM-DD-slug.md</code>ã€‚ä¸å†™ slug åˆ™è‡ªåŠ¨ä½¿ç”¨æ—¶é—´æˆ³ã€‚
          </div>
        </div>

        <div class="admin-form-row">
          <label>æ ‡ç­¾ï¼ˆtagsï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰</label>
          <input id="post-tags" type="text" placeholder="gamma-ray, metasurface"
                 class="admin-input">
        </div>

        <div class="admin-form-row">
          <label>æ­£æ–‡å†…å®¹ï¼ˆæ”¯æŒ Markdownï¼‰</label>
          <textarea id="post-body" rows="18" class="admin-textarea"></textarea>
        </div>

        <button type="submit" class="admin-btn-save">
          ğŸš€ ä¿å­˜åˆ° GitHub
        </button>
        <span id="post-status" class="admin-status"></span>
      </form>
    </div>
  </div>

  <!-- ä¸‹æ–¹ï¼šå³ä¾§æ ã€Œå·¥ä½œã€å†…å®¹ç¼–è¾‘ -->
  <div class="admin-card admin-work">
    <div class="admin-work-header">
      <div>
        <h2 class="admin-section-title">å³ä¾§æ ã€Œå·¥ä½œã€å†…å®¹</h2>
        <div class="admin-token-sub">
          å¯¹åº”ä»“åº“æ–‡ä»¶ <code>_includes/work.md</code>ï¼Œç”¨äºåšå®¢å³è¾¹å¡ç‰‡é‡Œçš„å·¥ä½œä»‹ç»ã€‚
        </div>
      </div>
      <button id="work-save" class="admin-btn-outline-small">ä¿å­˜å·¥ä½œå†…å®¹</button>
    </div>
    <textarea id="work-body" rows="6" class="admin-textarea"></textarea>
    <span id="work-status" class="admin-status"></span>
  </div>

  <!-- äºŒæ¬¡å…ƒå›¾ç‰‡æ”¶è—ç®¡ç† -->
  <div class="admin-card admin-gallery">
    <div class="admin-gallery-header">
      <div>
        <h2 class="admin-section-title">äºŒæ¬¡å…ƒå›¾ç‰‡æ”¶è—åŒº</h2>
        <div class="admin-token-sub">ç®¡ç† <code>_data/gallery.json</code>ï¼Œåœ¨é¦–é¡µã€Œç½‘ç«™åº“ã€é¡µé¢å±•ç¤ºã€‚</div>
      </div>
      <button id="gallery-refresh" class="admin-btn-outline-small">åˆ·æ–°åˆ—è¡¨</button>
    </div>

    <form id="gallery-form" class="admin-gallery-form">
      <div class="admin-form-row">
        <label>æ ‡é¢˜</label>
        <input id="gallery-title" type="text" class="admin-input" placeholder="ä¾‹å¦‚ï¼šæ¨±èŠ±ä¸å’Œé£" required>
      </div>
      <div class="admin-form-row">
        <label>å›¾ç‰‡é“¾æ¥ï¼ˆå»ºè®® https:// å¼€å¤´çš„å¯å…¬å¼€è®¿é—®åœ°å€ï¼‰</label>
        <input id="gallery-url" type="url" class="admin-input" placeholder="https://..." required>
      </div>
      <div class="admin-form-row">
        <label>æ¥æºï¼ˆå¯é€‰ï¼‰</label>
        <input id="gallery-source" type="url" class="admin-input" placeholder="åŸå›¾æ¥æºé“¾æ¥">
      </div>
      <div class="admin-gallery-actions">
        <button type="submit" class="admin-btn-save">æ·»åŠ å¹¶ä¿å­˜</button>
        <span id="gallery-status" class="admin-status"></span>
      </div>
    </form>

    <div id="gallery-list" class="admin-gallery-list">
      <!-- åŠ¨æ€å¡«å…… -->
    </div>
  </div>
</div>

<!-- ====== åå°ä¸“ç”¨æ ·å¼ï¼ˆå¤ç”¨åšå®¢å¡ç‰‡é£æ ¼ï¼‰ ====== -->
<style>
  .admin-page {
    max-width: 1200px;
    margin: 0 auto 40px;
  }

  .admin-title {
    margin-bottom: 4px;
  }

  .admin-desc {
    font-size: 14px;
    color: #6b7280;
    margin-bottom: 14px;
  }

  .admin-card {
    background: #ffffff;
    border-radius: 14px;
    padding: 16px 18px 18px;
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.06);
    border: 1px solid #e5e7eb;
  }

  .admin-token-card {
    margin-bottom: 18px;
  }

  .admin-shell {
    display: grid;
    grid-template-columns: 320px minmax(0, 1fr);
    gap: 22px;
    margin-bottom: 18px;
  }

  .admin-left, .admin-right, .admin-work {
    align-self: flex-start;
  }

  .admin-gallery {
    margin-top: 18px;
  }

  .admin-section-title {
    font-size: 16px;
    margin: 0;
  }

  .admin-token-header,
  .admin-right-header,
  .admin-work-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
  }

  .admin-token-title {
    font-size: 14px;
    font-weight: 600;
  }

  .admin-token-sub {
    font-size: 12px;
    color: #6b7280;
  }

  .admin-token-body {
    margin-top: 4px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 8px;
  }

  .admin-input {
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
    font-size: 14px;
    width: 100%;
    box-sizing: border-box;
  }

  .admin-input-short {
    width: 160px;
  }

  .admin-token-input {
    flex: 1;
    min-width: 220px;
  }

  .admin-textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid #d1d5db;
    font-family: monospace, Consolas, Menlo, "SF Mono", "Fira Code";
    font-size: 13px;
  }

  .admin-btn-primary,
  .admin-btn-save,
  .admin-btn-outline,
  .admin-btn-outline-small {
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
  }

  .admin-btn-primary {
    padding: 8px 14px;
    background: #2563eb;
    color: #ffffff;
  }

  .admin-btn-save {
    margin-top: 6px;
    padding: 8px 20px;
    background: #16a34a;
    color: #ffffff;
    font-size: 15px;
  }

  .admin-btn-outline {
    padding: 7px 12px;
    background: #ffffff;
    border: 1px solid #d1d5db;
    color: #374151;
  }

  .admin-btn-outline-small {
    padding: 5px 10px;
    background: #ffffff;
    border: 1px solid #d1d5db;
    color: #374151;
    font-size: 13px;
  }

  .admin-status {
    font-size: 13px;
    margin-left: 6px;
    color: #6b7280;
  }

  .admin-status-small {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 6px;
  }

  .admin-left-header {
    margin-bottom: 8px;
  }

  .admin-search {
    margin-bottom: 6px;
  }

  .admin-post-list {
    margin-top: 4px;
    max-height: 520px;
    overflow-y: auto;
    padding-right: 4px;
  }

  .admin-post-item {
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    margin-bottom: 6px;
    cursor: pointer;
    background: #f9fafb;
  }

  .admin-post-item:hover {
    background: #2563eb;
    color: #ffffff;
    border-color: #2563eb;
  }

  .admin-post-title {
    font-size: 14px;
    font-weight: 500;
  }

  .admin-post-meta {
    font-size: 12px;
    margin-top: 2px;
    opacity: 0.8;
  }

  .admin-current-file {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
  }

  .admin-form-row {
    margin-bottom: 10px;
  }

  .admin-form-row label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
  }

  .admin-help {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 2px;
  }

  .admin-work {
    margin-top: 4px;
  }

  .admin-gallery-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .admin-gallery-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
    align-items: end;
    margin-bottom: 10px;
  }

  .admin-gallery-actions {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .admin-gallery-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 10px;
  }

  .admin-gallery-item {
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 10px 12px;
    background: #f9fafb;
    box-shadow: 0 10px 26px rgba(15, 23, 42, 0.06);
  }

  .admin-gallery-title {
    font-weight: 600;
    margin: 0 0 4px 0;
  }

  .admin-gallery-url {
    word-break: break-all;
    font-size: 12px;
    color: #4b5563;
    margin: 0 0 6px 0;
  }

  .admin-gallery-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .admin-btn-danger {
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid #fecdd3;
    background: #fff1f2;
    color: #dc2626;
    cursor: pointer;
  }

  @media (max-width: 900px) {
    .admin-shell {
      grid-template-columns: 1fr;
    }
  }
</style>

<!-- ====== åå°é€»è¾‘è„šæœ¬ï¼šæ–‡ç« åˆ—è¡¨ + ç¼–è¾‘ + å·¥ä½œåŒºç¼–è¾‘ ====== -->
<script>
  (function() {
    const OWNER  = "huanyuheng";
    const REPO   = "huanyuheng.github.io";
    const BRANCH = "main";
    const API_BASE = "https://api.github.com/repos/" + OWNER + "/" + REPO + "/contents";
    const TOKEN_KEY = "blog_admin_token";

    let allPosts = [];
    let currentEditing = null;   // { path, sha, filename }
    let workSha = null;
    let galleryItems = [];
    let gallerySha = null;

    function getToken() {
      return localStorage.getItem(TOKEN_KEY) || "";
    }

    function setToken(t) {
      localStorage.setItem(TOKEN_KEY, t);
    }

    function encodeBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function decodeBase64(b64) {
      return decodeURIComponent(escape(atob(b64.replace(/\n/g, ""))));
    }

    function todayStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return y + "-" + m + "-" + dd;
    }

    async function apiGet(path) {
      const url = API_BASE + "/" + encodeURIComponent(path) + "?ref=" + encodeURIComponent(BRANCH);
      const headers = { "Accept": "application/vnd.github+json" };
      const token = getToken();
      if (token) {
        headers["Authorization"] = "token " + token;
      }
      const res = await fetch(url, { headers });
      if (!res.ok) {
        const data = await res.json().catch(() => ({}));
        const err = new Error(data.message || "GitHub GET error");
        err.response = data;
        err.status = res.status;
        throw err;
      }
      return res.json();
    }

    async function apiPut(path, bodyObj) {
      const token = getToken();
      if (!token) {
        alert("è¯·å…ˆåœ¨ä¸Šé¢ä¿å­˜ GitHub Tokenã€‚");
        throw new Error("No token");
      }
      const url = API_BASE + "/" + encodeURIComponent(path);
      const headers = {
        "Accept": "application/vnd.github+json",
        "Content-Type": "application/json",
        "Authorization": "token " + token
      };
      const res = await fetch(url, {
        method: "PUT",
        headers,
        body: JSON.stringify(bodyObj)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const err = new Error(data.message || "GitHub PUT error");
        err.response = data;
        err.status = res.status;
        throw err;
      }
      return data;
    }

    function parseFrontMatter(text) {
      const result = { meta: {}, body: text };
      if (!text.startsWith("---")) return result;

      const second = text.indexOf("\n---", 3);
      if (second === -1) return result;

      const metaText = text.slice(3, second).trim();
      const body = text.slice(second + 4); // è·³è¿‡ \n---

      const meta = {};
      metaText.split("\n").forEach(line => {
        const idx = line.indexOf(":");
        if (idx === -1) return;
        const key = line.slice(0, idx).trim();
        let value = line.slice(idx + 1).trim();
        if (
          (value.startsWith('"') && value.endsWith('"')) ||
          (value.startsWith("'") && value.endsWith("'"))
        ) {
          value = value.slice(1, -1);
        }
        meta[key] = value;
      });

      result.meta = meta;
      result.body = body;
      return result;
    }

    function renderPostList(list) {
      const listEl = document.getElementById("post-list");
      listEl.innerHTML = "";
      if (!list || list.length === 0) {
        listEl.innerHTML = '<div class="admin-status-small">å½“å‰æ²¡æœ‰æ–‡ç« ã€‚</div>';
        return;
      }

      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "admin-post-item";

        const nameNoExt = item.name.replace(/\.md$/, "");
        const datePart = nameNoExt.slice(0, 10);
        const slugPart = nameNoExt.length > 11 ? nameNoExt.slice(11) : nameNoExt;

        div.innerHTML =
          '<div class="admin-post-title">' + slugPart + '</div>' +
          '<div class="admin-post-meta">' + datePart + '</div>';

        div.addEventListener("click", function() {
          openPost(item.path);
        });

        listEl.appendChild(div);
      });
    }

    async function loadPostList() {
      const statusEl = document.getElementById("post-list-status");
      const listEl = document.getElementById("post-list");
      statusEl.textContent = "æ­£åœ¨åŠ è½½æ–‡ç« åˆ—è¡¨â€¦";
      listEl.innerHTML = "";

      try {
        const data = await apiGet("_posts");
        const files = (data || []).filter(function(item) {
          return item.type === "file" && item.name.endsWith(".md");
        });
        // æŒ‰æ–‡ä»¶åä»æ–°åˆ°æ—§æ’åº
        files.sort(function(a, b) {
          return a.name < b.name ? 1 : -1;
        });
        allPosts = files;
        renderPostList(allPosts);
        statusEl.textContent = "å…± " + allPosts.length + " ç¯‡æ–‡ç« ã€‚";
      } catch (err) {
        console.error("loadPostList error:", err);
        statusEl.textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token æƒé™æˆ–ç½‘ç»œã€‚";
      }
    }

    async function openPost(path) {
      const status = document.getElementById("post-status");
      status.style.color = "#6b7280";
      status.textContent = "æ­£åœ¨è¯»å–æ–‡ç« â€¦";

      try {
        const data = await apiGet(path);
        const text = decodeBase64(data.content);
        const parsed = parseFrontMatter(text);
        const meta = parsed.meta || {};
        const body = parsed.body || "";

        const filename = path.split("/").pop();
        const nameNoExt = filename.replace(/\.md$/, "");
        const dateFromName = nameNoExt.slice(0, 10);
        const slugFromName = nameNoExt.length > 11 ? nameNoExt.slice(11) : "";

        document.getElementById("post-title").value = meta.title || "";
        const metaDate = (meta.date || "").split(" ")[0];
        document.getElementById("post-date").value = metaDate || dateFromName || todayStr();
        document.getElementById("post-slug").value = slugFromName;
        document.getElementById("post-body").value = body.trim();

        let tagsStr = "";
        if (meta.tags) {
          tagsStr = meta.tags.replace(/[\[\]]/g, "");
        }
        document.getElementById("post-tags").value = tagsStr;

        document.getElementById("editor-title").textContent = "ç¼–è¾‘æ–‡ç« ";
        document.getElementById("current-file-info").textContent = "å½“å‰æ–‡ä»¶ï¼š" + path;

        currentEditing = {
          path: path,
          sha: data.sha,
          filename: filename
        };

        status.textContent = "å·²åŠ è½½ï¼Œå¯ä»¥ä¿®æ”¹åä¿å­˜ã€‚";
      } catch (err) {
        console.error("openPost error:", err);
        status.style.color = "#dc2626";
        status.textContent = "è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Token æƒé™ã€‚";
      }
    }

    function resetEditorToNew() {
      currentEditing = null;
      document.getElementById("editor-title").textContent = "æ–°å»ºæ–‡ç« ";
      document.getElementById("current-file-info").textContent = "";
      document.getElementById("post-title").value = "";
      document.getElementById("post-date").value = todayStr();
      document.getElementById("post-slug").value = "";
      document.getElementById("post-tags").value = "";
      document.getElementById("post-body").value = "";
      document.getElementById("post-status").textContent = "";
    }

    async function savePost(e) {
      e.preventDefault();

      const title = document.getElementById("post-title").value.trim();
      const date = document.getElementById("post-date").value.trim() || todayStr();
      let slug = document.getElementById("post-slug").value.trim();
      const tagsStr = document.getElementById("post-tags").value.trim();
      const body = document.getElementById("post-body").value || "";

      const status = document.getElementById("post-status");
      status.style.color = "#6b7280";

      if (!title || !body) {
        alert("æ ‡é¢˜å’Œæ­£æ–‡ä¸èƒ½ä¸ºç©ºã€‚");
        return;
      }

      if (!slug) {
        slug = "post-" + Date.now();
      }

      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const ss = String(now.getSeconds()).padStart(2, "0");
      const dateTime = date + " " + hh + ":" + mm + ":" + ss + " +0800";

      // tags è¡Œ
      let tagsLine = "";
      if (tagsStr) {
        const arr = tagsStr.split(",").map(function(s) { return s.trim(); }).filter(Boolean);
        if (arr.length > 0) {
          tagsLine = "tags: [" + arr.join(", ") + "]\n";
        }
      }

      const frontMatter =
        "---\n" +
        "layout: post\n" +
        "title: " + JSON.stringify(title).slice(1, -1) + "\n" +
        "date: " + dateTime + "\n" +
        tagsLine +
        "---\n";

      const fullContent = frontMatter + "\n" + body + "\n";
      const b64 = encodeBase64(fullContent);

      let path, msg;
      if (currentEditing) {
        path = currentEditing.path;
        msg = "æ­£åœ¨æ›´æ–°æ–‡ç« â€¦";
      } else {
        const filename = date + "-" + slug + ".md";
        path = "_posts/" + filename;
        msg = "æ­£åœ¨åˆ›å»ºæ–°æ–‡ç« â€¦";
      }

      status.textContent = msg;

      const bodyObj = {
        message: currentEditing ? ("Update " + currentEditing.filename) : ("Add " + path),
        content: b64,
        branch: BRANCH
      };

      if (currentEditing && currentEditing.sha) {
        bodyObj.sha = currentEditing.sha;
      }

      try {
        const data = await apiPut(path, bodyObj);
        const newSha = data && data.content && data.content.sha;
        currentEditing = {
          path: path,
          sha: newSha,
          filename: path.split("/").pop()
        };
        document.getElementById("current-file-info").textContent = "å½“å‰æ–‡ä»¶ï¼š" + path;
        status.style.color = "#16a34a";
        status.textContent = "ä¿å­˜æˆåŠŸï¼GitHub Pages å°†è‡ªåŠ¨é‡æ–°æ„å»ºã€‚";
        // é‡æ–°åŠ è½½æ–‡ç« åˆ—è¡¨
        loadPostList();
      } catch (err) {
        console.error("savePost error:", err);
        status.style.color = "#dc2626";
        status.textContent = "ä¿å­˜å¤±è´¥ï¼š" + (err.message || "æœªçŸ¥é”™è¯¯");
      }
    }

    function renderGalleryList(list) {
      const container = document.getElementById("gallery-list");
      container.innerHTML = "";
      if (!list || list.length === 0) {
        const p = document.createElement("div");
        p.className = "admin-status-small";
        p.textContent = "è¿˜æ²¡æœ‰å›¾ç‰‡ï¼Œå…ˆæ·»åŠ ä¸€å¼ å§ã€‚";
        container.appendChild(p);
        return;
      }

        list.forEach(function(item, idx) {
          const wrap = document.createElement("div");
          wrap.className = "admin-gallery-item";
          const source = item.source
            ? `<a href="${item.source}" target="_blank">æ¥æº</a>`
            : "<span class=\"admin-status-small\">æ— æ¥æº</span>";
          wrap.innerHTML = `
            <div class="admin-gallery-title">${item.title || "æœªå‘½å"}</div>
            <p class="admin-gallery-url">${item.url || ""}</p>
            <div class="admin-gallery-meta">
              ${source}
              <button class="admin-btn-danger" data-index="${idx}">åˆ é™¤</button>
            </div>
          `;
          container.appendChild(wrap);
        });
    }

    async function loadGallery() {
      const status = document.getElementById("gallery-status");
      status.style.color = "#6b7280";
      status.textContent = "æ­£åœ¨è¯»å– _data/gallery.jsonâ€¦";
      try {
        const data = await apiGet("_data/gallery.json");
        gallerySha = data.sha;
        const parsed = JSON.parse(decodeBase64(data.content) || "[]");
        galleryItems = Array.isArray(parsed) ? parsed : [];
        renderGalleryList(galleryItems);
        status.style.color = "#16a34a";
        status.textContent = "å·²åŠ è½½å›¾åº“ï¼Œå¯ç»§ç»­æ·»åŠ æˆ–åˆ é™¤ã€‚";
      } catch (err) {
        console.warn("loadGallery error:", err);
        gallerySha = null;
        galleryItems = [];
        renderGalleryList(galleryItems);
        status.style.color = "#9ca3af";
        status.textContent = "å½“å‰è¿˜æ²¡æœ‰ gallery.jsonï¼Œç¬¬ä¸€æ¬¡ä¿å­˜æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºã€‚";
      }
    }

    async function saveGallery() {
      const status = document.getElementById("gallery-status");
      status.style.color = "#6b7280";
      status.textContent = "æ­£åœ¨ä¿å­˜å›¾åº“â€¦";
      const jsonStr = JSON.stringify(galleryItems, null, 2) + "\n";
      const b64 = encodeBase64(jsonStr);
      const bodyObj = {
        message: "Update gallery.json",
        content: b64,
        branch: BRANCH
      };
      if (gallerySha) {
        bodyObj.sha = gallerySha;
      }
      try {
        const data = await apiPut("_data/gallery.json", bodyObj);
        gallerySha = data && data.content && data.content.sha;
        status.style.color = "#16a34a";
        status.textContent = "ä¿å­˜æˆåŠŸï¼";
        renderGalleryList(galleryItems);
      } catch (err) {
        console.error("saveGallery error:", err);
        status.style.color = "#dc2626";
        status.textContent = "ä¿å­˜å¤±è´¥ï¼š" + (err.message || "æœªçŸ¥é”™è¯¯");
      }
    }

    function handleGallerySubmit(e) {
      e.preventDefault();
      const title = document.getElementById("gallery-title").value.trim();
      const url = document.getElementById("gallery-url").value.trim();
      const source = document.getElementById("gallery-source").value.trim();
      if (!title || !url) {
        alert("æ ‡é¢˜å’Œå›¾ç‰‡é“¾æ¥ä¸èƒ½ä¸ºç©ºã€‚");
        return;
      }
      const item = { title: title, url: url };
      if (source) {
        item.source = source;
      }
      galleryItems.unshift(item);
      document.getElementById("gallery-title").value = "";
      document.getElementById("gallery-url").value = "";
      document.getElementById("gallery-source").value = "";
      renderGalleryList(galleryItems);
      saveGallery();
    }

    async function loadWork() {
      const status = document.getElementById("work-status");
      const textarea = document.getElementById("work-body");
      status.style.color = "#6b7280";
      status.textContent = "æ­£åœ¨è¯»å– _includes/work.mdâ€¦";

      try {
        const data = await apiGet("_includes/work.md");
        workSha = data.sha;
        textarea.value = decodeBase64(data.content);
        status.textContent = "å·²åŠ è½½ï¼Œå¯ä»¥ä¿®æ”¹åä¿å­˜ã€‚";
      } catch (err) {
        console.warn("loadWork error:", err);
        workSha = null;
        status.style.color = "#9ca3af";
        status.textContent = "å½“å‰è¿˜æ²¡æœ‰ work.mdï¼Œç¬¬ä¸€æ¬¡ä¿å­˜æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºã€‚";
        textarea.value = "";
      }
    }

    async function saveWork() {
      const status = document.getElementById("work-status");
      const textarea = document.getElementById("work-body");
      const text = textarea.value || "";

      status.style.color = "#6b7280";
      status.textContent = "æ­£åœ¨ä¿å­˜å·¥ä½œå†…å®¹â€¦";

      const b64 = encodeBase64(text);
      const bodyObj = {
        message: "Update work.md",
        content: b64,
        branch: BRANCH
      };
      if (workSha) {
        bodyObj.sha = workSha;
      }

      try {
        const data = await apiPut("_includes/work.md", bodyObj);
        workSha = data && data.content && data.content.sha;
        status.style.color = "#16a34a";
        status.textContent = "ä¿å­˜æˆåŠŸï¼";
      } catch (err) {
        console.error("saveWork error:", err);
        status.style.color = "#dc2626";
        status.textContent = "ä¿å­˜å¤±è´¥ï¼š" + (err.message || "æœªçŸ¥é”™è¯¯");
      }
    }

    function initAfterToken() {
      if (!getToken()) {
        document.getElementById("post-list-status").textContent = "å°šæœªä¿å­˜ Tokenï¼Œè¯·å…ˆåœ¨ä¸Šæ–¹ç²˜è´´ã€‚";
        return;
      }
      loadPostList();
      loadWork();
      loadGallery();
    }

    document.addEventListener("DOMContentLoaded", function() {
      // é»˜è®¤æ—¥æœŸ
      document.getElementById("post-date").value = todayStr();

      // Token çŠ¶æ€
      const tokenStatus = document.getElementById("token-status");
      if (getToken()) {
        tokenStatus.textContent = "å·²åœ¨æœ¬æœºä¿å­˜ Tokenã€‚";
        tokenStatus.style.color = "#16a34a";
        initAfterToken();
      } else {
        tokenStatus.textContent = "å°šæœªä¿å­˜ Tokenã€‚";
      }

      // ä¿å­˜ Token
      document.getElementById("save-token").addEventListener("click", function() {
        const v = document.getElementById("token-input").value.trim();
        if (!v) {
          alert("è¯·å…ˆç²˜è´´ä½ çš„ GitHub Tokenã€‚");
          return;
        }
        setToken(v);
        document.getElementById("token-input").value = "";
        tokenStatus.textContent = "Token å·²ä¿å­˜ï¼ˆä»…æœ¬æœºæµè§ˆå™¨ï¼‰ã€‚";
        tokenStatus.style.color = "#16a34a";
        initAfterToken();
      });

      // åˆ·æ–°æ–‡ç« åˆ—è¡¨
      document.getElementById("post-refresh").addEventListener("click", function() {
        initAfterToken();
      });

      // æœç´¢è¿‡æ»¤
      document.getElementById("post-search").addEventListener("input", function() {
        const q = this.value.trim().toLowerCase();
        if (!q) {
          renderPostList(allPosts);
          return;
        }
        const filtered = allPosts.filter(function(item) {
          return item.name.toLowerCase().indexOf(q) !== -1;
        });
        renderPostList(filtered);
      });

      // æ–°å»ºæ–‡ç« 
      document.getElementById("post-new").addEventListener("click", function() {
        resetEditorToNew();
      });

      // ä¿å­˜æ–‡ç« 
      document.getElementById("post-form").addEventListener("submit", savePost);

      // ä¿å­˜å·¥ä½œå†…å®¹
      document.getElementById("work-save").addEventListener("click", function() {
        saveWork();
      });

      // ä¿å­˜å›¾åº“
      document.getElementById("gallery-form").addEventListener("submit", handleGallerySubmit);
      document.getElementById("gallery-refresh").addEventListener("click", function() {
        loadGallery();
      });
      document.getElementById("gallery-list").addEventListener("click", function(e) {
        if (e.target && e.target.matches(".admin-btn-danger")) {
          const idx = parseInt(e.target.getAttribute("data-index"), 10);
          if (!isNaN(idx)) {
            galleryItems.splice(idx, 1);
            renderGalleryList(galleryItems);
            saveGallery();
          }
        }
      });
    });
  })();
</script>
